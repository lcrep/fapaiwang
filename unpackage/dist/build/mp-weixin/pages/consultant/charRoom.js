(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/consultant/charRoom"],{4652:function(t,e,o){"use strict";(function(t){o("312d");s(o("66fd"));var e=s(o("775a"));function s(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("543d")["createPage"])},"4b7c":function(t,e,o){"use strict";o.r(e);var s=o("8aac"),n=o.n(s);for(var a in s)"default"!==a&&function(t){o.d(e,t,(function(){return s[t]}))}(a);e["default"]=n.a},5685:function(t,e,o){"use strict";var s={"uni-load-more":function(){return o.e("components/uni-load-more/uni-load-more").then(o.bind(null,"61d8"))},"uni-icons":function(){return Promise.all([o.e("common/vendor"),o.e("components/uni-icons/uni-icons")]).then(o.bind(null,"df065"))},"uni-popup":function(){return o.e("components/uni-popup/uni-popup").then(o.bind(null,"47b6"))}},n=function(){var t=this,e=t.$createElement;t._self._c},a=[];o.d(e,"b",(function(){return n})),o.d(e,"c",(function(){return a})),o.d(e,"a",(function(){return s}))},"6ee4":function(t,e,o){"use strict";var s=o("8694"),n=o.n(s);n.a},"775a":function(t,e,o){"use strict";o.r(e);var s=o("5685"),n=o("4b7c");for(var a in n)"default"!==a&&function(t){o.d(e,t,(function(){return n[t]}))}(a);o("6ee4");var i,c=o("f0c5"),r=Object(c["a"])(n["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],i);e["default"]=r.exports},8694:function(t,e,o){},"8aac":function(t,e,o){"use strict";(function(t){var o;Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var s={data:function(){return{chatRel:"",myUserId:"",myPic:"",chatUserId:"",chatUserPic:"",chatUserName:"",chatText:"",viewId:"",isOpened:0,scrollTop:0,pageNum:1,itemId:1,videoSrc:"",loadStatus:"more",old:{scrollTop:0},chatList:[],videoContext:null}},onLoad:function(t){var e=this,o=t.myUserId,s=t.chatUserId;e.myUserId=o,e.chatUserId=s,e.chatRel=parseInt(o)>parseInt(s)?s+"_"+o:o+"_"+s,e.openSocket(o),e.getHistory(1)},onReady:function(){var e=this;this.videoContext=t.createVideoContext("myVideo"),setTimeout((function(){e.goBottom()}),100)},methods:{getHistory:function(e){var o=this,s={chatRel:o.chatRel,startPage:e};o.loadStatus="loading",o.$api.chatHistory(s).then((function(s){if(s.success){var n=s.datas.oppoUserId;n==o.myUserId?(o.myPic=s.datas.oppoUserHeadImg?s.datas.oppoUserHeadImg:"../../static/images/defaultUserPic.png",o.chatUserPic=s.datas.userHeadImg?s.datas.userHeadImg:"../../static/images/defaultUserPic.png",o.chatUserName=s.datas.userNickName):(o.myPic=s.datas.userHeadImg?s.datas.userHeadImg:"../../static/images/defaultUserPic.png",o.chatUserPic=s.datas.oppoUserHeadImg?s.datas.oppoUserHeadImg:"../../static/images/defaultUserPic.png",o.chatUserName=s.datas.oppoUserNickName),t.setNavigationBarTitle({title:o.chatUserName});var a=s.datas.rows;for(var i in a)a[i].fromUserId==o.myUserId?a[i].style="self":a[i].style="",a[i].itemId=o.itemId,o.itemId++;var c=o.chatList,r=a.concat(c);o.chatList=r,1==e?setTimeout((function(){o.goBottom()}),300):setTimeout((function(){o.viewId="mid"+10*e}),100);var l=s.datas.total,u=Math.ceil(l/10);parseInt(u)>parseInt(o.pageNum)?(o.pageNum++,o.loadStatus="more"):o.loadStatus="noMore"}else t.showToast({title:s.message,icon:"none"})}))},openSocket:function(t){var e=this;if("undefined"==typeof WebSocket)console.log("不支持WebSocket");else{console.log("支持WebSocket");var s="wss://mobile.fpw365.cn/ws/imchannel/"+t;null!=o&&(o.close(),o=null),o=new WebSocket(s),o.onopen=function(){e.isOpened=1},o.onmessage=function(t){var o;console.log(t.data);try{o=JSON.parse(t.data)}catch(s){console.log(s)}console.log(o),void 0!=o&&(o.fromUserId&&-1==o.fromUserId||e.listenMsg(o))},o.onclose=function(){console.log("websocket已关闭")},o.onerror=function(){console.log("websocket发生了错误")}}},listenMsg:function(t){var e=this,o={chatMsg:t.chatContent,chatTime:t.sendTime,fromUserId:t.fromUserId,msgType:t.contentType,toUserId:t.toUserId};e.chatList.push(o),setTimeout((function(){e.goBottom()}),100)},selMedia:function(e,o){var s,n=this;"image"==e?(s=1==o?["album"]:["camera"],t.chooseImage({count:1,sizeType:["original"],sourceType:s,success:function(e){var o=e.tempFiles[0].size;o>209715200?t.showToast({title:"文件过大",icon:"none"}):n.uploadImg(e)}})):"video"==e&&t.chooseVideo({count:1,sourceType:["camera","album"],success:function(e){console.log(e),e.size>209715200?t.showToast({title:"文件过大",icon:"none"}):n.uploadVideo(e)}})},uploadImg:function(e){var o=this,s={chatMsg:e.tempFilePaths[0],chatTime:o.$utils.formatTime(new Date),fromUserId:o.myUserId,msgType:"2",style:"self",toUserId:o.chatUserId,loading:1};o.chatList.push(s),setTimeout((function(){o.goBottom()}),100);var n,a=o.chatList.length-1;console.log(a),n=e.tempFilePaths[0],t.uploadFile({url:o.$api.filesUpload,name:"file",filePath:n,formData:{groupName:"chat"},success:function(e){if(200==e.statusCode){var s=JSON.parse(e.data);console.log(s),s.success?(o.addImgChat(s.datas),o.chatList[a].loading=0):(t.showToast({title:"上传失败"}),o.chatList[a].loading=2)}},fail:function(e){console.log(e),t.showToast({title:"上传失败",icon:"none"})}})},addImgChat:function(t){var e=this;console.log(t),0==e.isOpened&&(console.log("open socket"),e.openSocket());var s={contentType:2,toUserId:e.chatUserId,chatContent:t.picUrl};o.send(JSON.stringify(s))},uploadVideo:function(e){var o=this,s={chatMsg:e.tempFilePath,chatTime:o.$utils.formatTime(new Date),fromUserId:o.myUserId,msgType:"3",style:"self",toUserId:o.chatUserId,loading:1};o.chatList.push(s),setTimeout((function(){o.goBottom()}),100);var n,a=o.chatList.length-1;console.log(a),n=e.tempFilePath,t.uploadFile({url:o.$api.filesUpload,name:"file",filePath:n,formData:{groupName:"chat"},success:function(e){if(200==e.statusCode){var s=JSON.parse(e.data);console.log(s),s.success?(o.addVideoChat(s.datas),o.chatList[a].loading=0):(t.showToast({title:"上传失败"}),o.chatList[a].loading=2)}},fail:function(e){console.log(e),t.showToast({title:"上传失败",icon:"none"})}})},playVideo:function(t){var e=this;e.videoSrc=t,e.$nextTick((function(){e.$refs.showVideo.open()})),e.videoContext.play()},cancel:function(){var t=this;t.$nextTick((function(){t.$refs.showVideo.close()})),t.videoContext.pause()},addVideoChat:function(t){var e=this;console.log(t),0==e.isOpened&&(console.log("open socket"),e.openSocket());var s={contentType:3,toUserId:e.chatUserId,chatContent:t.picUrl};o.send(JSON.stringify(s))},sendMsg:function(){var t=this;0==t.isOpened&&(console.log("open socket"),t.openSocket());var e={contentType:1,toUserId:t.chatUserId,chatContent:t.chatText};o.send(JSON.stringify(e));var s={chatMsg:t.chatText,chatTime:t.$utils.formatTime(new Date),fromUserId:t.myUserId,msgType:"1",style:"self",toUserId:t.chatUserId};t.chatList.push(s),t.chatText="",setTimeout((function(){t.goBottom()}),100)},previewImage:function(e){var o=e.target.dataset.url;t.previewImage({urls:[o]})},upper:function(t){var e=this;"noMore"!=e.loadStatus&&1!=e.pageNum&&e.getHistory(e.pageNum)},lower:function(t){console.log("到底")},scroll:function(t){this.old.scrollTop=t.detail.scrollTop},goTop:function(e){this.scrollTop=this.old.scrollTop,this.$nextTick((function(){this.scrollTop=0})),t.showToast({icon:"none",title:"纵向滚动 scrollTop 值已被修改为 0"})},goBottom:function(){var t=this;t.scrollTop=t.old.scrollTop,t.$utils.getBoxheight(".msgList",(function(e){t.$nextTick((function(){t.scrollTop=e[0].height}))}))}}};e.default=s}).call(this,o("543d")["default"])}},[["4652","common/runtime","common/vendor"]]]);