(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/consultant/charRoom"],{4652:function(e,t,o){"use strict";(function(e){o("312d");s(o("66fd"));var t=s(o("775a"));function s(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("543d")["createPage"])},"4b7c":function(e,t,o){"use strict";o.r(t);var s=o("8aac"),n=o.n(s);for(var a in s)"default"!==a&&function(e){o.d(t,e,(function(){return s[e]}))}(a);t["default"]=n.a},"6ee4":function(e,t,o){"use strict";var s=o("8694"),n=o.n(s);n.a},"775a":function(e,t,o){"use strict";o.r(t);var s=o("f1d5"),n=o("4b7c");for(var a in n)"default"!==a&&function(e){o.d(t,e,(function(){return n[e]}))}(a);o("6ee4");var i,c=o("f0c5"),r=Object(c["a"])(n["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],i);t["default"]=r.exports},8694:function(e,t,o){},"8aac":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o={data:function(){return{chatRel:"",myUserId:"",timer:null,timeout:6e4,myPic:"",chatUserId:"",chatUserPic:"",chatUserName:"",chatText:"",viewId:"",isOpened:0,scrollTop:0,pageNum:1,itemId:1,videoSrc:"",loadStatus:"more",old:{scrollTop:0},chatList:[],videoContext:null}},onLoad:function(e){var t=this,o=e.myUserId,s=e.chatUserId;t.myUserId=o,t.chatUserId=s,t.chatRel=parseInt(o)>parseInt(s)?s+"_"+o:o+"_"+s,t.openSocket(o),t.getHistory(1)},onReady:function(){var t=this;this.videoContext=e.createVideoContext("myVideo"),setTimeout((function(){t.goBottom()}),100)},onShow:function(){0==this.isOpened&&this.openSocket(this.myUserId)},methods:{getHistory:function(t){var o=this,s={chatRel:o.chatRel,startPage:t};o.loadStatus="loading",o.$api.chatHistory(s).then((function(s){if(s.success){var n=s.datas.oppoUserId;n==o.myUserId?(o.myPic=s.datas.oppoUserHeadImg?s.datas.oppoUserHeadImg:"../../static/images/defaultUserPic.png",o.chatUserPic=s.datas.userHeadImg?s.datas.userHeadImg:"../../static/images/defaultUserPic.png",o.chatUserName=s.datas.userNickName):(o.myPic=s.datas.userHeadImg?s.datas.userHeadImg:"../../static/images/defaultUserPic.png",o.chatUserPic=s.datas.oppoUserHeadImg?s.datas.oppoUserHeadImg:"../../static/images/defaultUserPic.png",o.chatUserName=s.datas.oppoUserNickName),e.setNavigationBarTitle({title:o.chatUserName});var a=s.datas.rows;for(var i in a)a[i].fromUserId==o.myUserId?a[i].style="self":a[i].style="",3==a[i].msgType&&(a[i].coverPath=a[i].chatMsg+o.$utils.common.ossVideoCoverSuffix),a[i].itemId=o.itemId,o.itemId++;var c=o.chatList,r=a.concat(c);o.chatList=r,1==t?setTimeout((function(){o.goBottom()}),300):setTimeout((function(){o.viewId="mid"+10*t}),100);var l=s.datas.total,u=Math.ceil(l/10);parseInt(u)>parseInt(o.pageNum)?(o.pageNum++,o.loadStatus="more"):o.loadStatus="noMore"}else e.showToast({title:s.message,icon:"none"})}))},heartCheckStart:function(){var t=this;this.timer=setInterval((function(){1==t.isOpened?(console.log("连接状态，发送消息保持连接"),e.sendSocketMessage({data:"ping",success:function(e){console.log(e)},fail:function(e){console.log(e)}}),t.heartCheckReset(),t.heartCheckStart()):(console.log("断开连接，尝试重连"),t.openSocket(t.myUserId))}),this.timeout)},heartCheckReset:function(){clearTimeout(this.timer)},openSocket:function(t){var o=this,s="wss://mobile.fpw365.cn/ws/imchannel/"+t;e.connectSocket({url:s,complete:function(e){console.log("openSocket complete"+JSON.stringify(e))},fail:function(e){console.log("openSocket error"+JSON.stringify(e))}}),e.onSocketOpen((function(e){console.log("WebSocket 已打开"),o.isOpened=1,o.heartCheckReset(),o.heartCheckStart()})),e.onSocketMessage((function(e){var t;console.log(msg.data),o.heartCheckReset(),o.heartCheckStart();try{t=JSON.parse(msg.data)}catch(s){console.log(s)}console.log(t),void 0!=t&&(t.fromUserId&&-1==t.fromUserId||o.listenMsg(t))})),e.onSocketClose((function(e){console.log("WebSocket 已关闭！"),o.isOpened=0})),e.onSocketError((function(e){console.log("WebSocket连接打开失败，请检查！"),o.isOpened=0}))},listenMsg:function(e){var t=this,o={chatMsg:e.chatContent,chatTime:e.sendTime,fromUserId:e.fromUserId,msgType:e.contentType,toUserId:e.toUserId};3==e.contentType&&(o.coverPath=e.chatContent+t.$utils.common.ossVideoCoverSuffix),t.chatList.push(o),setTimeout((function(){t.goBottom()}),100)},selMedia:function(t,o){var s,n=this;"image"==t?(s=1==o?["album"]:["camera"],e.chooseImage({count:1,sizeType:["original"],sourceType:s,success:function(t){var o=t.tempFiles[0].size;o>209715200?e.showToast({title:"文件过大",icon:"none"}):n.uploadImg(t)}})):"video"==t&&e.chooseVideo({count:1,sourceType:["camera","album"],success:function(t){console.log(t),t.size>209715200?e.showToast({title:"文件过大",icon:"none"}):n.uploadVideo(t)}})},uploadImg:function(t){var o=this,s={chatMsg:t.tempFilePaths[0],chatTime:o.$utils.formatTime(new Date),fromUserId:o.myUserId,msgType:"2",style:"self",toUserId:o.chatUserId,loading:1};o.chatList.push(s),setTimeout((function(){o.goBottom()}),100);var n,a=o.chatList.length-1;n=t.tempFilePaths[0],e.uploadFile({url:o.$api.filesUpload,name:"file",filePath:n,formData:{groupName:"chat"},success:function(t){if(200==t.statusCode){var s=JSON.parse(t.data);console.log(s),s.success?(o.addImgChat(s.datas),o.chatList[a].loading=0):(e.showToast({title:"上传失败"}),o.chatList[a].loading=2)}},fail:function(t){console.log(t),e.showToast({title:"上传失败",icon:"none"})}})},addImgChat:function(t){var o=this;console.log(t),0==o.isOpened&&(console.log("open socket"),o.openSocket(o.myUserId));var s={contentType:2,toUserId:o.chatUserId,chatContent:t.picUrl};e.sendSocketMessage({data:JSON.stringify(s),success:function(e){console.log(e)},fail:function(e){console.log(e)}})},uploadVideo:function(t){var o=this,s={chatMsg:t.tempFilePath,chatTime:o.$utils.formatTime(new Date),fromUserId:o.myUserId,msgType:"3",style:"self",toUserId:o.chatUserId,loading:1};o.chatList.push(s),setTimeout((function(){o.goBottom()}),100);var n,a=o.chatList.length-1;console.log(a),n=t.tempFilePath,e.uploadFile({url:o.$api.filesUpload,name:"file",filePath:n,formData:{groupName:"chat"},success:function(t){if(200==t.statusCode){var s=JSON.parse(t.data);console.log(s),s.success?(o.addVideoChat(s.datas),o.chatList[a].loading=0,o.chatList[a].coverPath=s.datas.picUrl+o.$utils.common.ossVideoCoverSuffix):(e.showToast({title:"上传失败"}),o.chatList[a].loading=2)}},fail:function(t){console.log(t),e.showToast({title:"上传失败",icon:"none"})}})},playVideo:function(t){var o=this;o.videoSrc=t,o.videoContext=e.createVideoContext("myVideo"),o.$nextTick((function(){o.$refs.showVideo.open(),setTimeout((function(){o.videoContext.requestFullScreen(),o.videoContext.play()}),300)}))},cancel:function(){var e=this;e.$nextTick((function(){e.$refs.showVideo.close()})),e.videoContext.pause()},addVideoChat:function(t){var o=this;console.log(t),0==o.isOpened&&(console.log("open socket"),o.openSocket(o.myUserId));var s={contentType:3,toUserId:o.chatUserId,chatContent:t.picUrl};e.sendSocketMessage({data:JSON.stringify(s),success:function(e){console.log(e)},fail:function(e){console.log(e)}})},sendMsg:function(){var t=this;0==t.isOpened&&(console.log("open socket"),t.openSocket(t.myUserId));var o={contentType:1,toUserId:t.chatUserId,chatContent:t.chatText};e.sendSocketMessage({data:JSON.stringify(o)});var s={chatMsg:t.chatText,chatTime:t.$utils.formatTime(new Date),fromUserId:t.myUserId,msgType:"1",style:"self",toUserId:t.chatUserId};t.chatList.push(s),t.chatText="",setTimeout((function(){t.goBottom()}),100)},previewImage:function(t){var o=t.target.dataset.url;e.previewImage({urls:[o]})},upper:function(e){var t=this;"noMore"!=t.loadStatus&&1!=t.pageNum&&t.getHistory(t.pageNum)},lower:function(e){console.log("到底")},scroll:function(e){this.old.scrollTop=e.detail.scrollTop},goTop:function(t){this.scrollTop=this.old.scrollTop,this.$nextTick((function(){this.scrollTop=0})),e.showToast({icon:"none",title:"纵向滚动 scrollTop 值已被修改为 0"})},goBottom:function(){var e=this;e.scrollTop=e.old.scrollTop,e.$utils.getBoxheight(".msgList",(function(t){e.$nextTick((function(){e.scrollTop=t[0].height}))}))}}};t.default=o}).call(this,o("543d")["default"])},f1d5:function(e,t,o){"use strict";var s={"uni-icons":function(){return Promise.all([o.e("common/vendor"),o.e("components/uni-icons/uni-icons")]).then(o.bind(null,"df065"))},"uni-popup":function(){return o.e("components/uni-popup/uni-popup").then(o.bind(null,"47b6"))}},n=function(){var e=this,t=e.$createElement;e._self._c},a=[];o.d(t,"b",(function(){return n})),o.d(t,"c",(function(){return a})),o.d(t,"a",(function(){return s}))}},[["4652","common/runtime","common/vendor"]]]);